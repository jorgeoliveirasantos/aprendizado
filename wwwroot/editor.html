<!--Sessões criadas no final???-->

<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./index.css">
    <script src="./index.js"></script>
    <link rel="shortcut icon" href="./files/logo.svg" type="image/x-icon">
    <title>Aprendizado | Jorge Souza</title>
</head>

<body>
    <div class="Shell">
        <!-- Linha 1 MENU-->
        <div class="menu" id="menu"></div>
        <!-- Linha 2 APP -->
        <div class="App">
            <div class="app-barralateral-esquerda">
            </div>
            <div class="app-conteudo">
                <div class="editor-ferramentas">
                    <button onclick="Editor.Abrir()">Abrir</button>
                    <!--<button onclick="Editor.AbrirProjeto()">Abrir</button>-->
                    <input type="text" id="editor-titulo-txt" placeholder="Título do curso" value="">
                    <input type="text" id="editor-senha-txt" placeholder="Senha de edição" value="">
                    <button onclick="Editor.InserirImagem()">Imagem</button>
                    <button onclick="Editor.Download()">Baixar</button>
                    <span></span>
                    <button onclick="Editor.Previa()" style="border-color: coral;">Prévia</button>
                    <button onclick="Editor.Publicar()" style="border-color: springgreen;">Publicar</button>
                </div>
                <textarea id="editor-txt" rows="30"></textarea>
                <div style="padding: 10px; background-color: #FB0; color: black; text-align: center;">PRÉVIA</div>
                <div class="editor">
                </div>
            </div>
            <div class="app-barralateral-direita"></div>
        </div>
        <!-- Linha 2 APP -->
        <div class="app-rodape" id="app-rodape"></div>
    </div>
    <modal></modal>
    <div class="btn-up" id="btn-up"></div>
</body>
<script>
    loadElements();
</script>
<script>
    const Editor = {
        Curso: {
            Senha: document.getElementById("editor-titulo-txt"),
            Nome: document.getElementById("editor-senha-txt"),
            Arquivo: {},
            Imagens: {}
        },
        TxtEditor: document.getElementById("editor-txt"),
        Abrir: () => {
            let arq = document.createElement("input");
            arq.setAttribute("type", "file");
            arq.setAttribute("accept", ".curso");
            arq.oninput = () => {
                arq.files[0].arrayBuffer().then(data => {
                    Editor.TxtEditor.value = new TextDecoder().decode(data);
                }).catch(error => {
                    alert(error);
                });
            }
            arq.click();
        },
        Publicar: () => {
            if (document.getElementById("editor-titulo-txt").value == "" || document.getElementById("editor-senha-txt").value == "") {
                alert("Preencha o título e a senha do curso!");
            } else {
                Editor.Curso.Nome = document.getElementById("editor-titulo-txt").value;
                Editor.Curso.Senha = document.getElementById("editor-senha-txt").value;
                Editor.Formatar(false, () => {
                    let senha = prompt("Insira a senha:");
                    if (senha.length > 5) {
                        solicitacao(`${_URL}/editor/acessar`, senha, "POST").then(data => {
                            console.log(data);
                            solicitacao(`${_URL}/editor/${data}`, Editor.Curso, "POST").then(data => {
                                console.log(data);
                                //
                            }).catch(err => {
                                console.log(err);
                            });
                        }).catch(err => {
                            console.log(err);
                            alert("Senha inválida!");
                        });
                    } else {
                        alert("Senha inválida!");
                    }
                    async function solicitacao(_caminho, _data, _metodo) {
                        let res = await fetch(_caminho, {
                            method: _metodo,
                            headers: {
                                'Content-Type': 'text/plain'
                            },
                            mode: "no-cors",
                            body: JSON.stringify(_data)
                        });
                        return res.text();
                    };
                })
            }
        },
        Previa: () => {
            let editor;
            Editor.Formatar(true, () => {
                editor = document.getElementsByClassName("editor")[0];
                editor.innerHTML = "";
                for (const i in Editor.Curso.Arquivo) {
                    let post = document.createElement("div");
                    post.setAttribute("class", "js-post");
                    post.innerHTML = Editor.Curso.Arquivo[i];
                    editor.appendChild(post);
                }
            });
            //
            if (confirm("Baixar o arquivo HTML?")) {
                let arq = document.createElement('a');
                arq.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(editor.innerHTML));
                arq.setAttribute("download", "previa.html");
                arq.click();
                arq = undefined;
            }
        },
        Download: () => {
            if (document.getElementById("editor-titulo-txt").value == "" || document.getElementById("editor-senha-txt").value == "") {
                alert("Preencha o título e a senha do curso!");
            } else {
                download();
            }
            function download() {
                Editor.Curso.Nome = document.getElementById("editor-titulo-txt").value;
                Editor.Curso.Senha = document.getElementById("editor-senha-txt").value;
                let projeto = document.createElement('a');
                projeto.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(Editor.TxtEditor.value));
                projeto.setAttribute("download", `${Editor.Curso.Senha}__${Editor.Curso.Nome}.curso`);
                projeto.click();
                projeto = undefined;
            }
        },
        InserirImagem: () => {
            let img = document.createElement("input");
            img.setAttribute("type", "file");
            img.setAttribute("accept", ".png, .jpg, .jpeg, .webp");
            img.setAttribute("multiple", true);
            img.oninput = () => {
                for (let i = 0; i < img.files.length; i++) {
                    let reader = new FileReader();
                    reader.onloadend = () => {
                        Editor.Curso.Imagens[img.files[i].name] = reader.result;
                        Editor.TxtEditor.value += `%img ${img.files[i].name}\n`;
                    }
                    //reader.readAsBinaryString(img.files[0]);
                    //reader.readAsArrayBuffer(img.files[0]);
                    reader.readAsDataURL(img.files[0]);
                    //reader.readAsText(img.files[0]);
                };
            }
            img.click();
        },
        Formatar: (previa, callback) => {
            let original = Editor.TxtEditor.value;
            let linhas = original.split("\n");
            let sessao = "";
            let nomeSessao = "";
            let primeiraSessao = true;
            //
            let linhaTipo = "p";
            for (const linha of linhas) {
                let paragrafo = "";
                if (linha.includes("%titulo1 ")) {
                    sessao += `<h1>${linha.replaceAll("%titulo1 ", "")}</h1>\n`;
                }
                else if (linha.includes("%titulo2 ")) {
                    sessao += `<h2>${linha.replaceAll("%titulo2 ", "")}</h2>\n`;
                }
                else if (linha.includes("%titulo3 ")) {
                    sessao += `<h3>${linha.replaceAll("%titulo3 ", "")}</h3>\n`;
                }
                else if (linha.includes("%lista")) {
                    sessao += substitui(linha) + "\n";
                    linhaTipo = "lista";
                }
                else if (linha.includes("%pcodigo")) {
                    sessao += substitui(linha) + "\n";
                    linhaTipo = "pcodigo";
                }
                else if (linha.includes("%nota")) {
                    sessao += substitui(linha) + "\n";
                    linhaTipo = "nota";
                }
                else if (linha.includes("%sessao")) {
                    sessao += "\n";
                }
                else if (linha.includes("%img ")) {
                    if (previa) {
                        sessao += `<img src="${Editor.Curso.Imagens[linha.replaceAll("%img ", "")]}">\n`;
                    } else {
                        delete Editor.Curso.Imagens;
                        sessao += `<img src="${linha.replaceAll("%img ", "")}">\n`;
                    }
                }
                else if (linha.includes("pcodigo%")) {
                    sessao += substitui(linha) + "\n";
                    linhaTipo = "p";
                } else if (linha.includes("nota%")) {
                    sessao += substitui(linha) + "\n";
                    linhaTipo = "p";
                } else if (linha.includes("lista%")) {
                    sessao += substitui(linha) + "\n";
                    linhaTipo = "p";
                } else {
                    if (linha != "") {
                        switch (linhaTipo) {
                            case "lista":
                                sessao += `<li>${substitui(linha)}</li>\n`;
                                break;
                            case "nota":
                                sessao += substitui(linha) + "\n";
                                break;
                            case "p":
                                sessao += `<p>${substitui(linha)}</p>\n`;
                                break;
                            case "pcodigo":
                                sessao += substitui(linha) + "\n";
                                break;
                            default:
                                sessao += substitui(linha) + "\n";
                                break;
                        }
                    } else {
                        sessao += substitui(linha) + "\n";
                        linhaTipo = "p";
                    }
                }
                //
                if (linha.includes("%sessao ")) {
                    if (primeiraSessao) {
                        primeiraSessao = false;
                        nomeSessao = linha.replaceAll("%sessao ", "");
                    } else {
                        Editor.Curso.Arquivo[nomeSessao] = sessao;
                        sessao = "";
                        nomeSessao = linha.replaceAll("%sessao ", "");
                    }
                }
                if (linha == linhas[linhas.length - 1]) {
                    Editor.Curso.Arquivo[nomeSessao] = sessao;
                }
                if (linha == linhas[0] && !linha.startsWith("%sessao")) {
                    alert('Cada sessão deve iniciar com "%sessao Nome da Sessão"!');
                }
            }
            //Substituições:
            function substitui(txt) {
                return `${txt.replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('</', '&lt/')
                    .replaceAll('**n ', '<strong> ').replaceAll(' n**', ' </strong>')
                    .replaceAll('**i ', '<em> ').replaceAll(' i**', ' </em>')
                    .replaceAll('**s ', '<u> ').replaceAll(' s**', ' </u>')
                    .replaceAll('**botao ', '<a class="js-button-inline" target="_blank" ').replaceAll(' botao**', ' </a>').replaceAll('**l ', 'href="').replaceAll(' l**', '">')
                    .replaceAll('%codigo ', '<span class="codigo"> ').replaceAll(' codigo%', ' </span>')
                    .replaceAll('%pcodigo', '<pre class="pcodigo">').replaceAll('pcodigo%', '</pre>')
                    .replaceAll('%nota', '<p class="nota">').replaceAll('nota%', '</p>')
                    .replaceAll('%lista', '<ul class="lista">').replaceAll('lista%', '</ul>')}`;
            }
            callback();
        }
    }
    document.getElementById("editor-txt").value = `%sessao Sessao 01
%titulo1 Meu Título
%titulo2 Meu Título médio
%titulo3 Meu Título pequeno

Cada arquivo HTML é criado a partir de uma sessão, todo projeto deve iniciar com um nome de sessão, este será o nome do arquivo.

Links podem ser **botao **l https://google.com l** inline botao** ou um botão de única linha.

A Formatação é muito simples e pode incluir **n negrito n** **i itálico i** e **s sublinhado s**, além de %codigo código em linha codigo%.

Os parágrafos devem estar numa única linha, cada quebra de linha gera uma tag de parágrafo. Insira as imagens utilizando o editor para que seja feita a leitura dos dados binários para o visualizar arquivo. Elas não serãp enviadas ao servidor e devem constar na pasta:

%img minhaimagem.jpg

%pcodigo
Quer inserir um bloco de código?
    &lt;button onclick="Editor.InserirImagem()"&gt;Imagem&lt;/button&gt;
        &lt;button onclick="Editor.Download()"&gt;Baixar&lt;/button&gt;
            &lt;span&gt;&lt;/span&gt;
                Com identação! Mas cuide das linhas muito compridas.
pcodigo%

%nota
    Os blocos de nota servem para inserir um texto destacado do restante, avisos e alerta, ele são todos em itálico e alinhados à direita, tudo dentro de um bloco de código deve ser inserido numa única linha.
nota%

%lista
    As listas são simples.
    Fáceis de utilizar.
    E recebem marcadores especiais.
    Mas não use em listas numeradas.
    As listas numeradas são parágrafos comuns.
lista%

E para inserir uma nova sessão, apenas repita a tag, mas tome muito cuidado! Um sessão com o mesmo nome da anterior, apenas substituiá a anterior.

%sessao Sessao 02
%titulo1 Meu Título
%titulo2 Meu Título médio
%titulo3 Meu Título pequeno

A Formatação é muito simples e pode incluir **n negrito n** **i itálico i** e **s sublinhado s**, além de %codigo código em linha codigo%.

Os parágrafos devem estar numa única linha, cada quebra de linha gera uma tag de parágrafo. Insira as imagens utilizando o editor para que seja feita a leitura dos dados binários para o arquivo. É assim que ela será enviada ao servidor:

%img ["a.jpg", "/9j/4AAQSkZJRgABAQEAYABgAAD/4QB4RXhpZgAATU0AKgAAAAgABgExAAIAAAARAAAAVgMBAAUAAAABAAAAaAMDAAEAAAABAAAAAFEQAAEAAAABAQAAAFERAAQAAAABAAAOxFESAAQAAAABAAAOxAAAAAB3d3cuaW5rc2NhcGUub3JnAAAAAYagAACxj//bAEMAAgEBAgEBAgICAgICAgIDBQMDAwMDBgQEAwUHBgcHBwYHBwgJCwkICAoIBwcKDQoKCwwMDAwHCQ4PDQwOCwwMDP/bAEMBAgICAwMDBgMDBgwIBwgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDP/AABEIABsAaAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APqSiiivy8/zvCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/2Q=="]

%pcodigo
Quer inserir um bloco de código?
    &lt;button onclick="Editor.InserirImagem()"&gt;Imagem&lt;/button&gt;
        &lt;button onclick="Editor.Download()"&gt;Baixar&lt;/button&gt;
            &lt;span&gt;&lt;/span&gt;
                Com identação! Mas cuide das linhas muito compridas.
pcodigo%

%nota
    Os blocos de nota servem para inserir um texto destacado do restante, avisos e alerta, ele são todos em itálico e alinhados à direita, tudo dentro de um bloco de código deve ser inserido numa única linha.
nota%

%lista
    As listas são simples.
    Fáceis de utilizar.
    E recebem marcadores especiais.
    Mas não use em listas numeradas.
    As listas numeradas são parágrafos comuns.
lista%

E para inserir uma nova sessão, apenas repita a tag, mas tome muito cuidado! Um sessão com o mesmo nome da anterior, apenas substituiá a anterior.


%sessao Sessao 03
%titulo1 Meu Título
%titulo2 Meu Título médio
%titulo3 Meu Título pequeno

A Formatação é muito simples e pode incluir **n negrito n** **i itálico i** e **s sublinhado s**, além de %codigo código em linha codigo%.

Os parágrafos devem estar numa única linha, cada quebra de linha gera uma tag de parágrafo. Insira as imagens utilizando o editor para que seja feita a leitura dos dados binários para o arquivo. É assim que ela será enviada ao servidor:

%img ["a.jpg", "/9j/4AAQSkZJRgABAQEAYABgAAD/4QB4RXhpZgAATU0AKgAAAAgABgExAAIAAAARAAAAVgMBAAUAAAABAAAAaAMDAAEAAAABAAAAAFEQAAEAAAABAQAAAFERAAQAAAABAAAOxFESAAQAAAABAAAOxAAAAAB3d3cuaW5rc2NhcGUub3JnAAAAAYagAACxj//bAEMAAgEBAgEBAgICAgICAgIDBQMDAwMDBgQEAwUHBgcHBwYHBwgJCwkICAoIBwcKDQoKCwwMDAwHCQ4PDQwOCwwMDP/bAEMBAgICAwMDBgMDBgwIBwgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDP/AABEIABsAaAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APqSiiivy8/zvCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/2Q=="]

%pcodigo
Quer inserir um bloco de código?
    &lt;button onclick="Editor.InserirImagem()"&gt;Imagem&lt;/button&gt;
        &lt;button onclick="Editor.Download()"&gt;Baixar&lt;/button&gt;
            &lt;span&gt;&lt;/span&gt;
                Com identação! Mas cuide das linhas muito compridas.
pcodigo%

%nota
    Os blocos de nota servem para inserir um texto destacado do restante, avisos e alerta, ele são todos em itálico e alinhados à direita, tudo dentro de um bloco de código deve ser inserido numa única linha.
nota%

%lista
    As listas são simples.
    Fáceis de utilizar.
    E recebem marcadores especiais.
    Mas não use em listas numeradas.
    As listas numeradas são parágrafos comuns.
lista%

E para inserir uma nova sessão, apenas repita a tag, mas tome muito cuidado! Um sessão com o mesmo nome da anterior, apenas substituiá a anterior.

`;
</script>

</html>